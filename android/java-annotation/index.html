<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="xiaozhou blog"><link rel="stylesheet" type="text/css" href="//fonts.loli.net/css?family=Source+Code+Pro"><link rel="stylesheet" type="text/css" href="/css/style.css?v=2.0.4"><link rel="stylesheet" type="text/css" href="/css/highlight.css?v=2.0.4"><link rel="Shortcut Icon" href="/favicon.ico"><link rel="bookmark" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><link rel="stylesheet" type="text/css" href="https://unpkg.com/gitalk/dist/gitalk.css?v=2.0.4"><title>【java】Mapper 自定义注解器 | xiaozhou Blog</title><meta name="generator" content="Hexo 4.2.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">【java】Mapper 自定义注解器</h1><a id="logo" href="/.">xiaozhou Blog</a><p class="description"></p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a></div><div id="search-form"><div id="result-mask" class="hide"></div><label><input id="search-key" type="text" autocomplete="off" placeholder="搜索"></label><div id="result-wrap" class="hide"><div id="search-result"></div></div><div class="hide"><template id="search-tpl"><div class="item"><a href="/{path}" title="{title}"><div class="title">{title}</div><div class="time">{date}</div><div class="tags">{tags}</div></a></div></template></div></div></div><div id="layout" class="layout-g"><div class="layout-l"><div class="content_container"><div class="post"><h1 class="post-title">【java】Mapper 自定义注解器</h1><div class="post-meta"><a href="/android/java-annotation/#comments" class="comment-count"></a><p><span class="date">Jul 12, 2020</span><span><a href="/categories/android/" class="category">android</a></span><span><i id="busuanzi_container_page_pv"><i id="busuanzi_value_page_pv"></i><i>点击</i></i></span></p></div><div class="post-content"><p>java 自定义注解器，提交私仓 maven</p>
<h3 id="1-java-自定义注解器"><a href="#1-java-自定义注解器" class="headerlink" title="1. java 自定义注解器"></a>1. java 自定义注解器</h3><h4 id="1-1-注解器作用"><a href="#1-1-注解器作用" class="headerlink" title="1.1 注解器作用"></a>1.1 注解器作用</h4><p>通过元注解对类、变量等进行标记，在代码编译期通过解析器 <code>AbstractProcessor</code> 进行解析，快速实现模板代码的构建等作用</p>
<h4 id="1-2-自定义注解"><a href="#1-2-自定义注解" class="headerlink" title="1.2 自定义注解"></a>1.2 自定义注解</h4><p>通过 <code>@interface</code> 实现注解，如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@Target(ElementType.TYPE)</span><br><span class="line">@Retention(RetentionPolicy.CLASS)</span><br><span class="line">public @interface MapType &#123;</span><br><span class="line">	String name() default &quot;&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="1-3-实现一个解析器-Processor"><a href="#1-3-实现一个解析器-Processor" class="headerlink" title="1.3 实现一个解析器 Processor"></a>1.3 实现一个解析器 <code>Processor</code></h4><ol>
<li>必须继承 <code>AbstractProcessor</code>，通过方法 <code>public boolean process(Set&lt;? extends TypeElement&gt; annotations, RoundEnvironment roundEnv)</code> 对定义的注解类型进行解析。</li>
<li>需要重写 <code>getSupportedAnnotationTypes()</code> 声明对哪些些注解生效</li>
<li>在 <code>init(ProcessingEnvironment processingEnv)</code> 中获取工具类，如：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public synchronized void init(ProcessingEnvironment processingEnv) &#123;</span><br><span class="line">        super.init(processingEnv);</span><br><span class="line">	Types typeUtils &#x3D; processingEnv.getTypeUtils();</span><br><span class="line">	Elements elementUtils &#x3D; processingEnv.getElementUtils();</span><br><span class="line">	Filter filer &#x3D; processingEnv.getFiler();</span><br><span class="line">	Messager messager &#x3D; processingEnv.getMessager();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h4 id="1-4-解析注解，构建类"><a href="#1-4-解析注解，构建类" class="headerlink" title="1.4 解析注解，构建类"></a>1.4 解析注解，构建类</h4><p>从自定义解析器可以获取并处理自定义注解类型，动态构建类可以通过 <code>JavaWriter</code> 或者 <code>JavaPoet</code>。<br><code>JavaPoet</code> 是对 <code>JavaWriter</code> 的进一步封装。<br>如何使用参考官网介绍：<br><a href="https://github.com/square/javapoet" target="_blank" rel="noopener">JavaPoet github 链接</a></p>
<h3 id="2-实现注解库"><a href="#2-实现注解库" class="headerlink" title="2. 实现注解库"></a>2. 实现注解库</h3><p>新建 java library，建议使用 idea 的 maven/gradle 工程</p>
<h4 id="2-1-mapper-annotation-注解库"><a href="#2-1-mapper-annotation-注解库" class="headerlink" title="2.1 mapper-annotation 注解库"></a>2.1 mapper-annotation 注解库</h4><p>新建 java library，命名为 mapper-annotation，用于存放注解。<br>也可以把注解、解析器等放在同一个库中，但一般解析器所依赖的库只需要在编译期使用，不需要打包进主工程，所以会选择库拆分。</p>
<h4 id="2-2-mapper-compiler-解析库"><a href="#2-2-mapper-compiler-解析库" class="headerlink" title="2.2 mapper-compiler 解析库"></a>2.2 mapper-compiler 解析库</h4><p>同样新建 java library，再添加 <code>JavaPoet</code> 依赖，在 module 的 build.gradle 中添加 <code>implementation group: &#39;com.squareup&#39;, name: &#39;javapoet&#39;, version: &#39;1.8.0&#39;</code><br>在项目调试阶段，增加注解库依赖 <code>implementation project(&quot;:mapper-annotation&quot;)</code>，在调试完成后，可以将直接依赖替换为线上依赖，如 <code>implementation &#39;com.lib:mapper-annotation:1.0.0&#39;</code></p>
<h4 id="2-3-mapper-aar-库"><a href="#2-3-mapper-aar-库" class="headerlink" title="2.3 mapper aar 库"></a>2.3 mapper aar 库</h4><p>这个库主要是存放对外访问的接口。给 android 项目使用，如果没有这类需求可以不加，或者也可以放入 annotation 库中，不是必要创建的库。<br>新建 android library，同样需要添加对 annotation 依赖，在上线后替换为线上版本，如上。</p>
<h3 id="3-自定义-mapper-注解库需求及实现"><a href="#3-自定义-mapper-注解库需求及实现" class="headerlink" title="3. 自定义 mapper 注解库需求及实现"></a>3. 自定义 mapper 注解库需求及实现</h3><h4 id="3-1-构建需求"><a href="#3-1-构建需求" class="headerlink" title="3.1 构建需求"></a>3.1 构建需求</h4><p>在业务项目中使用了大量的组件，在使用中需要根据用户的组件类型去匹配，呈现该组件。在原先开发中，流程如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">private void showComponent(Item item)&#123;</span><br><span class="line">	String type &#x3D; item.getType();</span><br><span class="line">	if(&quot;A&quot;.equals(type)&#123;</span><br><span class="line">		Component cc &#x3D; new A(item);</span><br><span class="line">		cc.show();</span><br><span class="line">	&#125;else if(&quot;B&quot;.equals(type)&#123;</span><br><span class="line">		Component cc &#x3D; new B(item);</span><br><span class="line">		cc.show();</span><br><span class="line">	&#125;else if(&quot;C&quot;.equals(type)&#123;</span><br><span class="line">		Component cc &#x3D; new C(item);</span><br><span class="line">		cc.show();</span><br><span class="line">	&#125;else &#123;</span><br><span class="line">		&#x2F;&#x2F;...</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在少量组件的情况下，使用 if-else 结构清晰，但随着项目扩展，这段判断特别长，因此有了第一次改造，修改后如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">private static HashMap&lt;Strng,Class&gt; map &#x3D; new HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">static&#123;</span><br><span class="line">	map.put(&quot;A&quot;,A.class);</span><br><span class="line">	map.put(&quot;B&quot;,B.class);</span><br><span class="line">	map.put(&quot;C&quot;,C.class);</span><br><span class="line">	&#x2F;&#x2F;...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">private void showComponent(Item item)&#123;</span><br><span class="line">	Class clz &#x3D; map.get(item.getType());</span><br><span class="line">	if(clz!&#x3D;null)&#123;</span><br><span class="line">		try&#123;</span><br><span class="line">			Component cc &#x3D; clz.getConstructor(Item.class).newInstance(item);</span><br><span class="line">			cc.show();</span><br><span class="line">		&#125;catch (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过 HashMap 查找，让 if-else 瞬间去无踪，但是前提还是需要先构建 Map，为了一步到位，决定使用注解方式实现，彻底释放双手。</p>
<h4 id="3-2-实现"><a href="#3-2-实现" class="headerlink" title="3.2 实现"></a>3.2 实现</h4><ol>
<li>定义注解<br>因为可能存在组的概念，所以需要定义一个组名，再定义key用于标记该类，同时可能存在多个不同类型使用同一个类情况，提供一个组存放所有的类型，那么该注解完整如下所示：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">@Target(ElementType.TYPE)</span><br><span class="line">@Retention(RetentionPolicy.CLASS)</span><br><span class="line">public @interface MapType &#123;</span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 存放组</span><br><span class="line">     *&#x2F;</span><br><span class="line">    String group() default Constant.defaultGroup;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 用于标记的 key</span><br><span class="line">     *&#x2F;</span><br><span class="line">    String name() default &quot;&quot;;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 多个 key 共用一个类，可以使用 array 标记</span><br><span class="line">     *&#x2F;</span><br><span class="line">    String[] array() default &#123;&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
定义注解用于类，并保持到源码，defalut 是默认值，由于提供了一组使用，所以允许 name 或者 array 其中一个为空，但在构建需要对 name 和 array 进行都为空判断，不允许都为空，而 group 提供一个默认组存放。</li>
<li>解析注解<br>新建解析器 <code>MapProcessor</code>，继承 <code>AbstractProcessor</code></li>
</ol>
<p><strong>注意：需要在 main 中创建目录 C:\code\AnnotationApp\mapper-compiler\src\main\resources\META-INF\services 并添加注解器声明文件javax.annotation.processing.Processor，内容为自定义的注解器完整类名，如下图。当然可以通过 google 提供的 AutoService 自动生成，依赖为<code>compile group: &#39;com.google.auto.service&#39;, name: &#39;auto-service&#39;, version: &#39;1.0-rc7&#39;</code></strong><br><img src="https://i.loli.net/2020/07/12/SWzNrit2sKJGxYl.png" alt="注解器配置"><br>在 process 进行解析，并通过 <code>JavaPoet</code> 去生成上面改造后 map 的静态代码。部分代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public boolean process(Set&lt;? extends TypeElement&gt; annotations, RoundEnvironment roundEnv) &#123;</span><br><span class="line">    if (!annotations.isEmpty()) &#123;</span><br><span class="line">        HashMap&lt;String, HashMap&lt;String, ClassName&gt;&gt; map &#x3D; new HashMap&lt;&gt;();</span><br><span class="line">        System.out.println(&quot;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; process start &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&quot;);</span><br><span class="line">        for (Element annotatedElement : roundEnv.getElementsAnnotatedWith(MapType.class)) &#123;</span><br><span class="line">            if (annotatedElement.getKind() &#x3D;&#x3D; ElementKind.CLASS) &#123;&#x2F;&#x2F;只对类的注解进行处理</span><br><span class="line">                MapType annotation &#x3D; annotatedElement.getAnnotation(MapType.class);</span><br><span class="line">                String group &#x3D; annotation.group();</span><br><span class="line">                String name &#x3D; annotation.name();</span><br><span class="line">                String[] array &#x3D; annotation.array();</span><br><span class="line"></span><br><span class="line">				&#x2F;&#x2F;空判断，不允许都为空，key 为空字符容易出现覆盖，同时需注意同组同key有覆盖风险！！</span><br><span class="line">                if (name.length() &#x3D;&#x3D; 0 &amp;&amp; array.length &#x3D;&#x3D; 0) &#123;</span><br><span class="line">                    &#x2F;&#x2F;写出异常日志</span><br><span class="line">                    log(Diagnostic.Kind.ERROR, &quot;type name and array are Empty.&quot;);</span><br><span class="line">                    continue;</span><br><span class="line">                &#125;</span><br><span class="line">                TypeElement typeElement &#x3D; (TypeElement) annotatedElement;</span><br><span class="line">                ClassName className &#x3D; ClassName.get(typeElement);&#x2F;&#x2F;获取被注解的类</span><br><span class="line">                log(&quot;className &gt;&gt; &quot; + className);</span><br><span class="line"></span><br><span class="line">				&#x2F;&#x2F;保存入临时 map</span><br><span class="line">                HashMap&lt;String, ClassName&gt; items &#x3D; map.get(group);</span><br><span class="line">                if (items &#x3D;&#x3D; null) &#123;</span><br><span class="line">                    items &#x3D; new HashMap&lt;&gt;();</span><br><span class="line">                    map.put(group, items);</span><br><span class="line">                &#125;</span><br><span class="line">                if (name.length() &gt; 0) &#123;</span><br><span class="line">                    items.put(name, className);</span><br><span class="line">                &#125;</span><br><span class="line">                if (array.length &gt; 0) &#123;</span><br><span class="line">                    for (String s : array) &#123;</span><br><span class="line">                        items.put(s, className);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F;构建静态class文件</span><br><span class="line">        try &#123;</span><br><span class="line"></span><br><span class="line">            ClassName hashMapName &#x3D; ClassName.get(HashMap.class);</span><br><span class="line">            ClassName stringName &#x3D; ClassName.get(String.class);</span><br><span class="line">            ClassName className &#x3D; ClassName.get(Class.class);</span><br><span class="line"></span><br><span class="line">            ParameterizedTypeName itemMap &#x3D; ParameterizedTypeName.get(hashMapName, stringName, className);</span><br><span class="line">            ParameterizedTypeName hashMap &#x3D; ParameterizedTypeName.get(hashMapName, stringName, itemMap);</span><br><span class="line"></span><br><span class="line">			&#x2F;&#x2F;创建 HashMap&lt;String,HashMap&lt;String,Class&gt;&gt; map;</span><br><span class="line">            FieldSpec fieldMap &#x3D; FieldSpec.builder(hashMap, &quot;map&quot;, Modifier.PUBLIC, Modifier.STATIC)</span><br><span class="line">                    .initializer(&quot;new $T()&quot;, hashMap)</span><br><span class="line">                    .build();</span><br><span class="line"></span><br><span class="line">            StringBuilder body &#x3D; new StringBuilder();</span><br><span class="line">            CodeBlock.Builder codeBuilder &#x3D; CodeBlock.builder()</span><br><span class="line">                    .addStatement(&quot;$T item&quot;, itemMap);</span><br><span class="line"></span><br><span class="line">            for (Map.Entry&lt;String, HashMap&lt;String, ClassName&gt;&gt; item : map.entrySet()) &#123;</span><br><span class="line">                body.setLength(0);</span><br><span class="line"></span><br><span class="line">                String group &#x3D; item.getKey();</span><br><span class="line">                System.out.println(&quot; &gt;&gt; group : &quot; + group + &quot; &lt;&lt; &quot;);</span><br><span class="line">                codeBuilder.addStatement(&quot;item &#x3D; new $T()&quot;, itemMap);</span><br><span class="line">                for (Map.Entry&lt;String, ClassName&gt; m : item.getValue().entrySet()) &#123;</span><br><span class="line">                    System.out.println(&quot;[ &quot; + m.getKey() + &quot;: &quot; + m.getValue());</span><br><span class="line">                    body.append(&quot;item.put(\&quot;&quot;).append(m.getKey()).append(&quot;\&quot;,&quot;).append(m.getValue()).append(&quot;.class);\n&quot;);</span><br><span class="line">                &#125;</span><br><span class="line">                codeBuilder.add(body.toString())</span><br><span class="line">                        .add(&quot;map.put(\&quot;&quot;).add(group).addStatement(&quot;\&quot;, item)&quot;);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">			&#x2F;&#x2F;构建静态class为 当前package.TypeMap$Data</span><br><span class="line">            TypeSpec.Builder classBuilder &#x3D; TypeSpec.classBuilder(&quot;TypeMap$Data&quot;)</span><br><span class="line">                    .addModifiers(Modifier.PUBLIC, Modifier.FINAL)</span><br><span class="line">                    .addField(fieldMap)</span><br><span class="line">                    .addStaticBlock(codeBuilder.build());</span><br><span class="line"></span><br><span class="line">            JavaFile javaFile &#x3D; JavaFile.builder(this.getClass().getPackage().getName(), classBuilder.build()).build();</span><br><span class="line">            javaFile.writeTo(filer);</span><br><span class="line">        &#125; catch (IOException e) &#123;</span><br><span class="line">            if (e instanceof FilerException) &#123;</span><br><span class="line">                &#x2F;&#x2F;</span><br><span class="line">            &#125; else</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(&quot;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; end &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&quot;);</span><br><span class="line"></span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">    return false;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样，在添加这个注解库后，通过 build 能够动态生成 TypeMap$Data。在android 工程中，生成的目录为 <code>\build\generated\ap_generated_sources\debug\out\com\lib\mapper</code>，内容如下：<br><img src="https://i.loli.net/2020/07/12/5USxhuIpPzKBNeg.png" alt="构建成功截图"><br>3. 对外暴露接口<br>在 mapper 中，定义静态类，用于链接上面生成的类。<br>由于 TypeMap$Data 是编译期才生成，如果在没有build之前，直接引用 <code>TypeMap$Data</code> 的成员变量，会报错，有可能导致项目无法构建，所以通过反射方式获取到成员变量，相关代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">public class Mapper &#123;</span><br><span class="line"></span><br><span class="line">    private final static HashMap&lt;String, HashMap&lt;String, Class&gt;&gt; collection;</span><br><span class="line"></span><br><span class="line">    static &#123;</span><br><span class="line">        HashMap&lt;String, HashMap&lt;String, Class&gt;&gt; temp &#x3D; null;</span><br><span class="line">        try &#123;</span><br><span class="line">            Class typeMap &#x3D; Class.forName(&quot;com.lib.mapper.TypeMap$Data&quot;);</span><br><span class="line">            Object instance &#x3D; typeMap.newInstance();</span><br><span class="line">            Field map &#x3D; typeMap.getField(&quot;map&quot;);</span><br><span class="line">            map.setAccessible(true);</span><br><span class="line">            &#x2F;&#x2F;noinspection unchecked</span><br><span class="line">            temp &#x3D; (HashMap&lt;String, HashMap&lt;String, Class&gt;&gt;) map.get(instance);</span><br><span class="line"></span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            temp &#x3D; new HashMap&lt;&gt;();</span><br><span class="line">        &#125; finally &#123;</span><br><span class="line">            collection &#x3D; temp;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">	&#x2F;&#x2F;省略其他</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样我们注解库编写完成。</p>
<h3 id="4-使用"><a href="#4-使用" class="headerlink" title="4. 使用"></a>4. 使用</h3><p>android 项目举例</p>
<p>添加依赖：<br>implementation project(‘:mapper’)</p>
<p>声明注解器依赖：<br>annotationProcessor project(‘:mapper-compiler’)</p>
<p><strong>如果需要对 kotlin 类注解</strong>，先引入 kotlin 相关插件，<br>再添加 <code>apply plugin:&#39;kotlin-kapt&#39;</code>，将 annotationProcessor 替换为 kapt，即 <code>kapt project(&#39;:mapper-compiler&#39;)</code></p>
<p>新建类，添加注解：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">@MapType(name &#x3D; &quot;testA&quot;, group &#x3D; &quot;love&quot;)</span><br><span class="line">public class TestA &#123;</span><br><span class="line">    public TestA() &#123;</span><br><span class="line">        System.out.println(getClass().getName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@MapType(name &#x3D; &quot;testB&quot;, array &#x3D; &#123;&quot;a&quot;, &quot;b&quot;, &quot;c&quot;&#125;)</span><br><span class="line">public class TestB &#123;</span><br><span class="line">    public TestB() &#123;</span><br><span class="line">        System.out.println(getClass().getName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@MapType(name &#x3D; &quot;testC&quot;)</span><br><span class="line">public class TestC &#123;</span><br><span class="line">    public TestC() &#123;</span><br><span class="line">        System.out.println(getClass().getName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>业务类中使用：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">private void function()&#123;</span><br><span class="line">	Class a &#x3D; Mapper.findItem(&quot;testA&quot;);</span><br><span class="line">	&#x2F;&#x2F;具体逻辑，需做空判断</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5-提交私仓-maven"><a href="#5-提交私仓-maven" class="headerlink" title="5. 提交私仓 maven"></a>5. 提交私仓 maven</h3><p>为了方便其他项目使用，我们可以把库提交到私仓，这里已假设存在私仓 maven。</p>
<h4 id="5-1-添加上传脚本"><a href="#5-1-添加上传脚本" class="headerlink" title="5.1 添加上传脚本"></a>5.1 添加上传脚本</h4><p>在两个 java-library 库均添加 maven 插件，并增加上传脚本，代码块如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">apply plugin: &#39;maven&#39;</span><br><span class="line"></span><br><span class="line">uploadArchives &#123;</span><br><span class="line">    repositories &#123;</span><br><span class="line">        mavenDeployer &#123;</span><br><span class="line">            repository(url: MAVEN_URL) &#123;</span><br><span class="line">                authentication(userName: USER_NAME, password: USER_PASSWORD)</span><br><span class="line">            &#125;</span><br><span class="line">            pom.project &#123;</span><br><span class="line">                groupId GROUP_ID&#x2F;&#x2F;定义的组</span><br><span class="line">                artifactId &#39;mapper-annotation&#39;&#x2F;&#x2F;库唯一标识</span><br><span class="line">                version &#39;1.0.0&#39;&#x2F;&#x2F;版本</span><br><span class="line">                packaging &#39;jar&#39;&#x2F;&#x2F;打包类型</span><br><span class="line">                description &#39;mapper-annotation&#39;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>两个库配置相似，区别在 artifactId 和 description 不同，版本号每次上传都需要改变。<br><strong>特别注意，上传jar不要用 SNAPSHOT 标识，每次上传都需要修改版本，相同版本无法覆盖！！如果使用，即使提示上传成功，你在引用的时候除非指定到特定版本，如 <code>implementation &#39;com.lib:mapper-annotation:1.0.1-20200711.111827-1&#39;</code>,否则不能准确获取最新的版本！</strong><br>配置不需要增加什么 task sourceJar，除非你完全理解 gradle task，否则有可能出现无法理解问题</p>
<p>当然，mapper 库也需要提交，增加配置如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">apply plugin: &#39;maven&#39;</span><br><span class="line"></span><br><span class="line">task sourcesJar(type: Jar) &#123;</span><br><span class="line">    baseName &quot;mapper&quot;</span><br><span class="line">    &#x2F;&#x2F;分类器，用于区别其他jar包</span><br><span class="line">    classifier &quot;sources&quot;</span><br><span class="line">    &#x2F;&#x2F;从main源集中的所有代码</span><br><span class="line">    from android.sourceSets.main.java.srcDirs</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">artifacts &#123;</span><br><span class="line">    archives sourcesJar</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">uploadArchives &#123;</span><br><span class="line">    repositories &#123;</span><br><span class="line">        mavenDeployer &#123;</span><br><span class="line">            repository(url: MAVEN_URL) &#123;</span><br><span class="line">                authentication(userName: USER_NAME, password: USER_PASSWORD)</span><br><span class="line">            &#125;</span><br><span class="line">            pom.project &#123;</span><br><span class="line">                groupId GROUP_ID</span><br><span class="line">                artifactId &#39;mapper&#39;</span><br><span class="line">                version &#39;1.0.0&#39;</span><br><span class="line">                packaging &#39;aar&#39;</span><br><span class="line">                description &#39;mapper&#39;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="5-2-修改依赖"><a href="#5-2-修改依赖" class="headerlink" title="5.2 修改依赖"></a>5.2 修改依赖</h4><ol>
<li>mapper-annotation 库<br> 因为 mapper 和 mapper-compiler 均依赖注解</li>
<li>注解器 mapper-compiler<br> 修改依赖注解为线上版本</li>
<li>对外库 mapper<br> 修改依赖注解为线上版本</li>
</ol>
<h4 id="5-3-上传"><a href="#5-3-上传" class="headerlink" title="5.3 上传"></a>5.3 上传</h4><p>打开 idea gradle 控制面板，在 upload 中逐个上传。</p>
<p>在其他需要的项目中，添加 mapper 依赖，增加注解器即可。</p>
<p><a href="https://github.com/maxiaozhou1234/Mapper" target="_blank" rel="noopener">项目地址，点我查阅</a></p>
</div><div class="post-copyright"><blockquote><p>原文作者: ma xiaozhou</p><p>原文链接: <a href="https://maxiaozhou1234.github.io/android/java-annotation/">https://maxiaozhou1234.github.io/android/java-annotation/</a></p><p>版权声明: 转载请注明出处(必须保留原文作者署名原文链接)</p></blockquote></div><div class="tags"><a href="/tags/java/">java</a><a href="/tags/android/">android</a></div><div class="post-share"><div class="social-share"><span>分享到:</span></div></div><div class="post-nav"><a href="/java/java-pipe/" class="pre">【java】Pipe</a><a href="/android/viewpager-anr/" class="next">【Android】无限循环ViewPager setCurrentItem 导致 ANR 分析</a></div><div id="comments"><div id="container"><script type="text/javascript" src="https://unpkg.com/gitalk/dist/gitalk.min.js?v=2.0.4"></script><script type="text/javascript" src="//cdn.bootcss.com/blueimp-md5/2.10.0/js/md5.js?v=2.0.4"></script><script>var gitalk = new Gitalk({
  clientID: 'caaf9fa61b214b649585',
  clientSecret: '99fa000941abd4c7f59a0cce1b1deb26813c4ed1',
  repo: 'maxiaozhou1234.github.io',
  owner: 'maxiaozhou1234',
  admin: ['maxiaozhou1234'],
  id: md5(window.location.pathname),
  distractionFreeMode: false,
  language: 'zh-CN',
  pagerDirection: 'last'
})
gitalk.render('container')</script></div></div></div></div></div><div class="layout-r"><div id="sidebar"><div class="search-pla"></div><div id="toc" class="widget"><div class="widget-title"><i class="fa fa-fei">文章目录</i></div><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-java-自定义注解器"><span class="toc-text">1. java 自定义注解器</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-注解器作用"><span class="toc-text">1.1 注解器作用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-自定义注解"><span class="toc-text">1.2 自定义注解</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3-实现一个解析器-Processor"><span class="toc-text">1.3 实现一个解析器 Processor</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-4-解析注解，构建类"><span class="toc-text">1.4 解析注解，构建类</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-实现注解库"><span class="toc-text">2. 实现注解库</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-mapper-annotation-注解库"><span class="toc-text">2.1 mapper-annotation 注解库</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-mapper-compiler-解析库"><span class="toc-text">2.2 mapper-compiler 解析库</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-mapper-aar-库"><span class="toc-text">2.3 mapper aar 库</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-自定义-mapper-注解库需求及实现"><span class="toc-text">3. 自定义 mapper 注解库需求及实现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-构建需求"><span class="toc-text">3.1 构建需求</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-实现"><span class="toc-text">3.2 实现</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-使用"><span class="toc-text">4. 使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-提交私仓-maven"><span class="toc-text">5. 提交私仓 maven</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-1-添加上传脚本"><span class="toc-text">5.1 添加上传脚本</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-2-修改依赖"><span class="toc-text">5.2 修改依赖</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-3-上传"><span class="toc-text">5.3 上传</span></a></li></ol></li></ol></div><div class="widget"><div class="widget-title"><i class="fa fa-xie"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/vue/vue-%E5%88%9D%E5%AD%A6%E9%97%AE%E9%A2%98%E5%B0%8F%E8%AE%B0/">【vue】 vue 初学问题小记</a></li><li class="post-list-item"><a class="post-list-link" href="/java/java-generic/">【java】泛型理解：协变、逆变、不变</a></li><li class="post-list-item"><a class="post-list-link" href="/default/note-of-computer/">【note】计算机组成原理总结</a></li><li class="post-list-item"><a class="post-list-link" href="/java/java-pipe/">【java】Pipe</a></li><li class="post-list-item"><a class="post-list-link" href="/android/java-annotation/">【java】Mapper 自定义注解器</a></li><li class="post-list-item"><a class="post-list-link" href="/android/viewpager-anr/">【Android】无限循环ViewPager setCurrentItem 导致 ANR 分析</a></li><li class="post-list-item"><a class="post-list-link" href="/android/pager-adapter/">【Android】PagerAdapter不刷新问题分析</a></li><li class="post-list-item"><a class="post-list-link" href="/sqlite/sqlite-test/">【sqlite】测试题</a></li><li class="post-list-item"><a class="post-list-link" href="/sqlite/sqlite-view/">【sqlite】VIEW 视图</a></li><li class="post-list-item"><a class="post-list-link" href="/sqlite/sqlite-trigger/">【sqlite】Trigger 触发器</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-gui"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/android/">android</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/default/">default</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/java/">java</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/sqlite/">sqlite</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/vue/">vue</a><span class="category-list-count">1</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-biao"> 标签</i></div><div class="tagcloud"><a href="/tags/gittalk/" style="font-size: 15px;">gittalk</a> <a href="/tags/hexo/" style="font-size: 15px;">hexo</a> <a href="/tags/MySQL/" style="font-size: 15px;">MySQL</a> <a href="/tags/sqlite/" style="font-size: 15px;">sqlite</a> <a href="/tags/java/" style="font-size: 15px;">java</a> <a href="/tags/nio/" style="font-size: 15px;">nio</a> <a href="/tags/android/" style="font-size: 15px;">android</a> <a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA/" style="font-size: 15px;">计算机</a> <a href="/tags/vue/" style="font-size: 15px;">vue</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-archive"> 归档</i></div><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/">2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/">2021</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/">2020</a><span class="archive-list-count">11</span></li></ul></div></div></div></div><a id="totop" href="#top"></a><div id="footer"><div class="footer-info"><p><a href="/baidusitemap.xml">网站地图</a> |  <a href="/atom.xml">订阅本站</a> |  <a href="/about/">联系博主</a></p><p>本站总访问量：<i id="busuanzi_container_site_pv"><i id="busuanzi_value_site_pv"></i></i>次，本站总访客数:<i id="busuanzi_container_site_uv"><i id="busuanzi_value_site_uv"></i></i>人</p><p><span> Copyright &copy;<a href="/." rel="nofollow">ma xiaozhou.</a></span><span> Theme by<a rel="nofollow" target="_blank" href="https://github.com/chaooo/hexo-theme-BlueLake"> BlueLake.</a></span><span> Count by<a href="http://busuanzi.ibruce.info/" target="_blank" rel="noopener"> busuanzi.</a></span><span> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a></span></p></div></div></div><script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?2329dcd6b360689143bd059b178d5961";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();
</script><script type="text/javascript" src="/js/search.json.js?v=2.0.4"></script><script type="text/javascript" src="/js/toctotop.js?v=2.0.4" async></script><link rel="stylesheet" type="text/css" href="/share/css/share.css"><script type="text/javascript" src="/share/js/social-share.js" charset="utf-8"></script><script type="text/javascript" src="/share/js/qrcode.js" charset="utf-8"></script></body></html>